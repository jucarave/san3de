/*===================================================
				BRITANNIAN UNDERWORLD
				
			By Camilo Ram√≠rez (Jucarave)
			
					  2014
===================================================*/

function requestFullscreen(e){if(e.webkitRequestFullScreen){e.webkitRequestFullScreen()}else{e.mozRequestFullScreen()}}var Utils={get:function(e){return document.getElementById(e)},addEvent:function(e,t,n){if(e.attachEvent){e.attachEvent("on"+t,n)}else if(e.addEventListener){e.addEventListener(t,n,false)}},getHttp:function(){var e;if(window.XMLHttpRequest){e=new XMLHttpRequest}else if(window.ActiveXObject){e=new window.ActiveXObject("Microsoft.XMLHTTP")}return e}};Math.iRandom=function(e,t){if(t==undefined){t=e;e=0}t-=e;return e+Math.floor(Math.random()*t)};Math.getAngle=function(e,t){var n=Math.abs(e.a-t.a);var r=Math.abs(e.b-t.b);var i=Math.atan2(r,n);if(t.a<=e.a&&t.b<=e.b){i=Math.PI-i}else if(t.a<=e.a&&t.b>e.b){i=Math.PI+i}else if(t.a>e.a&&t.b>e.b){i=Math.PI2-i}i=(i+Math.PI2)%Math.PI2;return i};Math.getShortAngle=function(e,t){var n=Math.abs(e-t)%Math.PI2;if(n>Math.PI)n=Math.PI2-n;return n};Math.getDistance=function(e,t){return Math.sqrt(Math.pow(e.a-t.a,2)+Math.pow(e.b-t.b,2))};Math.PI2=Math.PI*2;Math.PI_2=Math.PI/2;Math.PI3_2=3*Math.PI/2;Math.radRelation=Math.PI/180;Math.degRelation=180/Math.PI;Math.degToRad=function(e){return e*Math.radRelation};Math.radToDeg=function(e){return e*Math.degRelation};window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/30)};window.AudioContext=window.AudioContext||window.webkitAudioContext
function Billboard(e,t,n,r){this.position=e;this.textureCode=t;this.mapManager=r;this.imgIndex=0;this.imgSpd=0;this.imgNum=0;this.visible=t!="none";this.actionType=null;this.inMap=true;this.params=null;this.toggleImg=null;this.toggleImgInd=0;this.unlock=null;this.parseParams(n)}Billboard.prototype.parseParams=function(e){this.actionType=[];if(e&&e.length>0)for(var t=0,n=e.length;t<n;t++){var r=e[t].trim();if(r.indexOf("iN")==0){r=r.replace("iN","");this.imgSpd=1/3;this.imgNum=parseInt(r);this.imgIndex=Math.iRandom(this.imgNum)}else if(r=="iS0"){this.imgIndex=0;this.imgSpd=0}else if(r=="vH"){this.visible=false}else if(r=="tV"){this.actionType.push(r)}else if(r.indexOf("tI")==0){r=r.replace("tI","");this.actionType.push("tI");this.toggleImg=new Uint8ClampedArray(r.split("_"))}else if(r.indexOf("cW_")==0){this.params=r.replace("cW_","").split("_");for(var i=0;i<this.params.length;i++){this.params[i]=parseInt(this.params[i],10)}this.actionType.push("cW")}else if(r.indexOf("uD_")==0){var s=r.replace("uD_","").split("_");for(var i=0;i<s.length;i++){s[i]=parseInt(s[i],10)}this.unlock=vec2(s[0],s[1]);this.actionType.push("uD")}else if(r=="del"){this.actionType.push("del")}}};Billboard.prototype.isSolid=function(){var e=this.textureCode;if(this.imgNum>0)e+=this.imgIndex<<0;return this.mapManager.isTextureSolid(e)};Billboard.prototype.active=function(){if(this.actionType==null)return;for(var e=0,t=this.actionType.length;e<t;e++){var n=this.actionType[e];if(n=="tV"){this.visible=!this.visible}else if(n=="tI"){if(++this.toggleImgInd==this.toggleImg.length)this.toggleImgInd=0;this.imgIndex=this.toggleImg[this.toggleImgInd]}else if(n=="cW"){this.mapManager.changeWall(this.params[0],this.params[1],this.params[2])}else if(n=="uD"){var r=this.mapManager.getInstanceAt(this.unlock.a,this.unlock.b);if(r&&r.locked){r.locked=null}}else if(n=="del"){this.inMap=false}}};Billboard.prototype.getTexture=function(){var e=this.textureCode;if(this.imgNum>0)e+=this.imgIndex<<0;return{texCode:e,xScale:1}};Billboard.prototype.loop=function(){if(this.visible&&this.imgSpd>0&&this.imgNum>0){this.imgIndex+=this.imgSpd;if(this.imgIndex>=this.imgNum)this.imgIndex=0}}
var Colors={textures:[],texturesShadow:[],billboards:[],alphaC:[255,0,255],blackC:[0,0,0],ceil:[],floor:[],shadowF:[],parseColor:function(e){var t=parseInt(e.substring(0,2),16);var n=parseInt(e.substring(2,4),16);var r=parseInt(e.substring(4,6),16);return[t,n,r]},getDark:function(e){var t=Math.floor(e[0]*.5);var n=Math.floor(e[1]*.5);var r=Math.floor(e[2]*.5);return[t,n,r]}}
function Console(e,t,n){this.messages=[];this.maxMessages=e;this.game=n;this.font=t;this.fontS=parseInt(t.substring(0,t.indexOf("px")),10)}Console.prototype.addMessage=function(e,t,n){if(t!="unique"&&this.messages.length>0){var r=this.messages[this.messages.length-1];if(r.type==t){r.amount+=1;return}}var i={msg:e,type:t,color:n,amount:1};this.messages.push(i);if(this.messages.length>this.maxMessages){this.messages.splice(0,1)}};Console.prototype.render=function(e,t){var n=this.messages.length-1;var r=this.game.getCtx();r.font=this.font;for(var i=n;i>=0;i--){var s=this.messages[i];var o=s.msg;if(s.amount>1)o+=" (x"+s.amount+")";r.fillStyle=s.color;r.fillText(o,e,t);t-=this.fontS}}
function Door(e,t,n,r,i){this.position=e;this.direction=t;this.mapManager=i;this.texture=n;this.solid=false;this.imageIndex=0;this.imgSpeed=1/2;this.opening=0;this.locked=null;this.openable=true;this.parseParams(r);this.leftPos=null;this.rightPos=null;this.visible=true;if(t=="H"){this.solid=true;this.leftPos=vec2(e.a<<0,e.b);this.rightPos=vec2(1+e.a<<0,e.b)}else if(t=="V"){this.solid=true;this.leftPos=vec2(e.a,e.b<<0);this.rightPos=vec2(e.a,1+e.b<<0)}else if(t=="UR"){this.leftPos=vec2(e.a<<0,e.b<<0);this.rightPos=vec2(1+e.a<<0,1+e.b<<0)}else if(t=="DR"){this.leftPos=vec2(1+e.a<<0,e.b<<0);this.rightPos=vec2(e.a<<0,1+e.b<<0)}else if(t=="UL"){this.leftPos=vec2(e.a<<0,1+e.b<<0);this.rightPos=vec2(1+e.a<<0,e.b<<0)}else if(t=="DL"){this.leftPos=vec2(1+e.a<<0,1+e.b<<0);this.rightPos=vec2(e.a<<0,e.b<<0)}}Door.prototype.parseParams=function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];if(r.indexOf("L_")==0){this.locked=r.replace("L_","")}else if(r=="nOp"){this.openable=false}}};Door.prototype.getTexture=function(){var e="";if(this.openable)e=Math.floor(this.imageIndex)+"";return this.texture+e};Door.prototype.isSolid=function(e,t){if(this.direction=="V"||this.direction=="H"){return this.solid}else{var n,r;n=0;r=0;switch(this.direction){case"UR":n=e-this.leftPos.a;r=t-this.leftPos.b;if(r-.5<=n)return true;break;case"UL":n=this.leftPos.a-e;r=t-this.leftPos.b;if(r-.5<=n)return true;break;case"DR":n=e-this.rightPos.a;r=this.rightPos.b-t;if(r-.5<=n)return true;break;case"DL":n=this.leftPos.a-e;r=this.leftPos.b-t;if(r-.5<=n)return true;break}return false}};Door.prototype.active=function(){if(!this.openable)return;if(this.opening!=0)return;if(this.locked!=null){var e=this.mapManager.getInventoryItem(this.locked);if(e){this.mapManager.logMessage("Unlocked using the "+e.name,"locked_"+this.locked,"aqua");this.mapManager.removeFromInventory(this.locked,1);this.locked=null}else{this.mapManager.logMessage("The door is locked!","locked_"+this.locked,"yellow");return}}if(this.imageIndex==0){this.opening=1}else{this.opening=2;this.solid=true}};Door.prototype.loop=function(){if(this.opening==1){this.imageIndex+=this.imgSpeed;if(this.imageIndex>=4){this.opening=0;this.solid=false;this.imageIndex=3}}else if(this.opening==2){this.imageIndex-=this.imgSpeed;if(this.imageIndex<=0){this.opening=0;this.imageIndex=0}}}
function Enemy(e,t,n,r){this.position=e;this.textureCode=n;this.mapManager=r;this.direction=Math.degToRad(t);this.imageIndex=0;this.imgSpeed=0;this.imgNum=0;this.visible=true;this.inMap=true;this.solid=true;this.rotate=false}Enemy.prototype.getFaceByDirection=function(e){var t=0;var n=(Math.radToDeg(e)+360)%360<<0;if(n>25&&n<335){t=(n/50<<0)+1}return t};Enemy.prototype.setTexture=function(e,t,n){this.textureCode=e;this.imgNum=t;this.imgSpeed=n;this.imageIndex=0};Enemy.prototype.getTexture=function(e){var t=this.getFaceByDirection(e);var n=this.getFaceByDirection(this.direction);var r=1;t=(t+12-n)%8;if(t==5){t=3;r=-1}else if(t==6){t=2;r=-1}else if(t==7){t=1;r=-1}var i={texCode:this.textureCode+t+"_"+this.imageIndex,xScale:r};return i};Enemy.prototype.isSolid=function(){return this.solid};Enemy.prototype.loop=function(){if(this.imgSpeed>0&&this.imgNum>0){this.imageIndex+=this.imgSpeed;if(this.imageIndex>=this.imgNum)this.imageIndex=0}if(this.rotate){this.direction+=Math.PI2}}
function Engine(e,t){this.canvas=this.createCanvas(e,t);this.ctx=this.getCtx(this.canvas);this.audioCtx=null;if(window.AudioContext)this.audioCtx=new AudioContext;else alert("Your browser doesn't suppor the Audio API");this.audio=[];this.images=[]}Engine.prototype.createCanvas=function(e,t){var n=document.createElement("canvas");n.width=e.a;n.height=e.b;n.style.backgroundColor="black";t.appendChild(n);return n};Engine.prototype.getCtx=function(e){var t=e.getContext("2d");t.width=e.width;t.height=e.height;return t};Engine.prototype.loadImage=function(e){var t=new Image;t.src=e;t.ready=false;Utils.addEvent(t,"load",function(){t.ready=true});this.images.push(t);return t};Engine.prototype.parseMap=function(e){var t=parseInt(e[0].trim());var n=parseInt(e[1].trim());var r=new Array(n);var i=e[2].split(",");var s=0;for(var o=0;o<n;o++){r[o]=new Uint8ClampedArray(t);for(var u=0;u<t;u++){r[o][u]=i[s++]}}return r};Engine.prototype.parseTexture=function(e){if(!e)throw"Wrong number of parameters in texture";var t,n,r,i,s,o,u,a,f;t=e[0].trim();f=0;if(e.length==2||e.length==3){n=e.length==2?false:e[1].trim()=="T";a=e.length==2?1:2;u=new Uint8ClampedArray(e[a].split(","));r=Math.sqrt(u.length);if(Math.floor(r)!=r)throw"The texture must be a of a square size of a size must be specified";i=r;s=0;o=r;offsetB=i}else if(e.length==5){n=e[1].trim()=="T";r=parseInt(e[2].trim());i=parseInt(e[3].trim());u=new Uint8ClampedArray(e[4].split(","));s=0;o=r;offsetB=i}else if(e.length==7){n=e[1].trim()=="T";r=parseInt(e[2].trim());i=parseInt(e[3].trim());s=parseInt(e[4].trim());o=parseInt(e[5].trim());offsetB=i;u=new Uint8ClampedArray(e[6].split(","))}else if(e.length==9){n=e[1].trim()=="T";r=parseInt(e[2].trim());i=parseInt(e[3].trim());s=parseInt(e[4].trim());o=parseInt(e[5].trim());f=parseInt(e[6].trim());offsetB=parseInt(e[7].trim());u=new Uint8ClampedArray(e[8].split(","))}else{throw"Wrong number of parameters in texture: "+e.length}var l=new Texture(u,t,r,i,s,o,f,offsetB,n);return l};Engine.prototype.loadKTD=function(e,t,n){var r=this;var i=Utils.getHttp();var s={ready:false};i.open("GET","textures/"+e,true);i.onreadystatechange=function(){if(i.readyState==4&&i.status==200){var e=i.responseText.split("\n");var t=[];var o=[];var u={};var a={indexes:[null]};var f=[];var l=null;var c=null;var h=null;var p=1;for(var d=0,v=e.length;d<v;d++){var m=e[d].trim();if(m=="")continue;var g=m;var y=parseInt(g.substring(0,4));g=g.substring(5);if(y==0){var b=g.split(" ");c=r.parseMap(b)}else if(y==1){var b=g.split(" ");l=r.parseMap(b)}else if(y==2){var b=g.split(" ");h=r.parseMap(b)}else if(y==3){t=g.split(",");o=new Array(t.length);for(var w=0,E=t.length;w<E;w++){t[w]=Colors.parseColor(t[w]);o[w]=Colors.getDark(t[w])}}else if(y==4){var b=g.split(" ");u.x=parseInt(b[0].trim(),10);u.y=parseInt(b[1].trim(),10);u.d=parseFloat(b[2].trim())}else if(y==5){p=parseInt(g,10)}else if(y>=16&&y<48){var b=g.split(" ");var S=r.parseTexture(b);a.indexes.push(S.name);a[S.name]=S}else if(y>=48){var b=g.split(" ");f.push(b)}}s.ready=true;s.player=u;s.colors=t;s.colorsS=o;s.textures=a;s.instances=f;s.floor=l;s.ceil=c;s.map=h;s.height=p;if(n)n(s)}};i.setRequestHeader("Content-type","application/x-www-form-urlencoded");i.send();return s};Engine.prototype.getData=function(e){var t=this.ctx.createImageData(e.a,e.b);for(var n=0,r=t.data.length;n<r;n+=4){t.data[n+3]=255}return t};Engine.prototype.areImagesReady=function(){for(var e=0,t=this.images.length;e<t;e++){if(!this.images[e].ready)return false}return true};Engine.prototype.loadAudio=function(e,t){var n=this;if(!n.audioCtx)return null;var r={buffer:null,source:null,ready:false,isMusic:t};var i=Utils.getHttp();i.open("GET",e,true);i.responseType="arraybuffer";i.onload=function(){n.audioCtx.decodeAudioData(i.response,function(e){r.buffer=e;r.ready=true},function(e){alert(e)})};i.send();this.audio.push(r);return r};Engine.prototype.playSound=function(e,t,n){var r=this;if(!e||!e.ready){if(n){setTimeout(function(){r.playSound(e,t,n)},300)}return}var i=r.audioCtx.createBufferSource();i.buffer=e.buffer;i.connect(r.audioCtx.destination);i.start(0);i.loop=t;i.looping=t;if(e.isMusic)e.source=i}
function Game(){this.gameSize=vec2(320,200);this.eng=new Engine(this.gameSize,Utils.get("divGame"));this.font='10px "Arial"';this.console=new Console(10,this.font,this);this.render=new RaycastRender(this.eng.getData(vec2(208,127)),60,180,this);this.render.setFog(1,10);this.renderPos=vec2(16,17);this.canvasPos=vec2(this.eng.canvas.offsetLeft,this.eng.canvas.offsetTop);this.scale=this.eng.canvas.offsetHeight/200;this.map=null;this.scene=null;this.fps=Math.floor(1e3/30);this.numberFrames=0;this.firstFrame=Date.now();this.textures={};this.billboards={};this.keys=new Uint8ClampedArray(255);this.cursorPos=vec2(-1,-1);this.mouseB=0;this.lastT=0;this.inventory=[];this.images={};this.audios={};var e=this;this.loadImages();this.loadAudios();this.eng.loadKTD("kramBillboards.ktd",false,function(t){e.parseBillboards(t)});this.console.addMessage("Welcome to SAN3DE Alpha test!","unique","white");this.console.addMessage("Press WASD to move, QE to turn around","unique","white");this.console.addMessage("Press Enter to interact with doors and objects","unique","white");this.console.addMessage("Have fun!","unique","yellow")}Game.prototype.stopAllMusic=function(){for(var e in this.audios){var t=this.audios[e];if(t.isMusic&&t.source){t.stop();t.source=null}}};Game.prototype.playMusic=function(e){var t=this.audios[e];if(!t)return;this.stopAllMusic();this.eng.playSound(t,true,true)};Game.prototype.loadAudios=function(){this.audios.descent=this.eng.loadAudio("ogg/descent.ogg",true)};Game.prototype.loadImages=function(){this.images.titleS=this.eng.loadImage("img/titleScreen.png");this.images.viewport=this.eng.loadImage("img/viewport.png")};Game.prototype.newGame=function(e){var t=this;if(t.eng.areImagesReady()){t.scene=new TitleScreen(t);t.loopGame(e)}else{setTimeout(function(){t.newGame(e)},t.fps)}};Game.prototype.getCtx=function(){return this.eng.ctx};Game.prototype.getKeyPressed=function(e){if(this.keys[e]==1){this.keys[e]=2;return true}return false};Game.prototype.getMouseButtonPressed=function(){if(this.mouseB==1){this.mouseB=2;return true}return false};Game.prototype.parseBillboards=function(e){this.billboards=e.textures;Colors.billboards=e.colors};Game.prototype.parseMap=function(e){var t=this;t.textures=e.textures;t.map=new MapManager(t,e.map,e.player);t.map.createInstances(e.instances);t.map.floor=e.floor;t.map.ceil=e.ceil;t.map.height=e.height;Colors.textures=e.colors;Colors.texturesShadow=e.colorsS};Game.prototype.loadMap=function(e){var t=this;this.eng.loadKTD(e,true,function(e){t.parseMap(e)})};Game.prototype.getTexture=function(e){if(e==0||e===undefined)return null;var t=this.textures.indexes[e];if(!t)throw"Invalid Texture Index "+e+"!";if(!this.textures[t])throw"Invalid Texture Index "+e+"!";return this.textures[t]};Game.prototype.getTextureIdByCode=function(e){return this.textures.indexes.indexOf(e)};Game.prototype.getBillboard=function(e){if(!this.billboards[e])throw"Invalid Billboard Code "+e+"!";return this.billboards[e]};Game.prototype.drawFPS=function(e){var t=Math.floor(++this.numberFrames/((e-this.firstFrame)/1e3));var n=this.getCtx();n.font=this.font;n.fillStyle="white";n.fillText("FPS: "+t+"/30",16,16)};Game.prototype.drawInventory=function(){var e=this.getCtx();e.fillStyle="white";e.textAlign="right";e.font='10px "Courier"';for(var t=0,n=this.inventory.length;t<n;t++){var r=this.inventory[t];var i=r.amount?" x"+r.amount:"";e.fillText(r.name+i,e.width-16,16+t*10)}e.textAlign="left"};Game.prototype.loopGame=function(e){var t=this;var n=Date.now();var r=n-t.lastT;if(r>this.fps){t.lastT=n-r%this.fps;if(t.scene){t.scene.loop()}else if(t.map){t.render.raycast(t.map);t.map.loop();t.render.draw(t.getCtx(),t.renderPos);var i=t.getCtx();i.drawImage(t.images.viewport,0,0)}this.drawFPS(n)}requestAnimFrame(function(e){t.loopGame(e)})};Utils.addEvent(window,"load",function(){var e=new Game;e.newGame();var t=e.eng.canvas;Utils.addEvent(document,"keydown",function(t){if(window.event)t=window.event;if(e.keys[t.keyCode]==2)return;e.keys[t.keyCode]=1});Utils.addEvent(document,"keyup",function(t){if(window.event)t=window.event;e.keys[t.keyCode]=0});Utils.addEvent(t,"mousedown",function(t){if(window.event)t=window.event;var n=(t.clientX-e.canvasPos.a)/e.scale;var r=(t.clientY-e.canvasPos.b)/e.scale;if(e.mouseB==2)return;e.cursorPos.set(n,r);e.mouseB=1});Utils.addEvent(document,"mousemove",function(t){if(window.event)t=window.event;var n=(t.clientX-e.canvasPos.a)/e.scale;var r=(t.clientY-e.canvasPos.b)/e.scale;e.cursorPos.set(n,r)});Utils.addEvent(document,"mouseup",function(t){if(window.event)t=window.event;e.mouseB=0});Utils.addEvent(window,"focus",function(){e.firstFrame=Date.now();e.numberFrames=0})})
function Item(e,t,n,r){this.position=e;this.textureCode=t;this.mapManager=r;this.imgIndex=0;this.imgSpd=0;this.imgNum=0;this.visible=t!="none";this.amount=0;this.item=null;this.inMap=true;this.parseParams(n)}Item.prototype.parseParams=function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];if(r.indexOf("aM")==0){this.amount=parseInt(r.replace("aM",""),10)}else if(r.indexOf("iF")==0){var i=r.replace("iF","");this.item=ItemFactory.getItem(i)}}};Item.prototype.active=function(){if(!this.inMap)return;this.mapManager.addItem(this.item,this.amount);this.inMap=false};Item.prototype.isSolid=function(){var e=this.textureCode;if(this.imgNum>0)e+=this.imgIndex<<0;return this.mapManager.isTextureSolid(e)};Item.prototype.getTexture=function(){var e=this.textureCode;if(this.imgNum>0)e+=this.imgIndex<<0;return{texCode:e,xScale:1}};Item.prototype.loop=function(){if(this.visible&&this.imgSpd>0&&this.imgNum>0){this.imgIndex+=this.imgSpd;if(this.imgIndex>=this.imgNum)this.imgIndex=0}}
var ItemFactory={goldKey:{name:"golden key",type:"key",stackable:true},getItem:function(e){var t=ItemFactory[e];if(!t)throw"Invalid item code: "+e+"!";var n={};for(var r in t){n[r]=t[r]}n.itemCode=e;return n}}
function MapManager(e,t,n){this.game=e;this.player=null;this.instances=[];this.doors=[];this.traps=[];this.map=t;this.floor=null;this.ceil=null;this.baseHeight=1;this.player=new Player(vec2(n.x+.5,n.y+.5),n.d,this);this.waterTiles=[];this.animatedTiles=[];this.worldFrame=0;this.worldFrameSpeed=1/8;this.sectorInstances=[];this.sectorDoors=[]}MapManager.prototype.isAnimated=function(e){return this.animatedTiles.indexOf(e)!=-1};MapManager.prototype.checkIfWater=function(e,t){if(!this.floor[t])return false;var n=this.floor[t][e];if(this.waterTiles.indexOf(n)!=-1){return true}return false};MapManager.prototype.isSolid=function(e,t){if(!this.map[t])return false;var n=this.map[t][e];var r=this.game.getTexture(n);if(!r)return false;return r.solid};MapManager.prototype.isOnTrap=function(e){var t=e.a<<0;var n=e.b<<0;for(var r=0,i=this.traps.length;r<i;r++){if(this.traps[r].position.equals(t,n)){this.game.render.falling=true;return true}}};MapManager.prototype.isTextureSolid=function(e){var t=this.game.textures[e];if(t==null)t=this.game.billboards[e];if(t&&t.solid){return true}return false};MapManager.prototype.getInstanceAt=function(e,t){for(var n=0,r=this.sectorInstances.length;n<r;n++){var i=this.sectorInstances[n];if(i.position.a<<0==e&&i.position.b<<0==t)return i}for(var n=0,r=this.sectorDoors.length;n<r;n++){var i=this.sectorDoors[n];if(i.position.a<<0==e&&i.position.b<<0==t)return i}return null};MapManager.prototype.logMessage=function(e,t,n){if(!this.game.console)return;this.game.console.addMessage(e,t,n)};MapManager.prototype.changeWall=function(e,t,n){this.map[t][e]=n};MapManager.prototype.addItem=function(e,t){var n=this.game.inventory;if(e.stackable){var r=false;for(var i=0,s=n.length;i<s;i++){if(n[i].itemCode==e.itemCode){n[i].amount+=t;r=true;i=s}}if(!r){var o=t>1?t:"a(n)";this.logMessage("Picked "+o+" "+e.name,"pick_"+e.name,"aqua");e.amount=t;n.push(e)}}else{for(var i=0;i<t;i++){this.logMessage("Picked a(n) "+e.name,"pick_"+e.name,"aqua");n.push(e)}}};MapManager.prototype.getInventoryItem=function(e){var t=null;var n=this.game.inventory;for(var r=0,i=n.length;r<i;r++){if(n[r].itemCode==e){t=n[r];r=i}}return t};MapManager.prototype.removeFromInventory=function(e,t){var n=this.game.inventory;for(var r=0,i=n.length;r<i;r++){if(t==0){r=i}else if(n[r].itemCode==e){if(n[r].amount!==undefined&&n[r].amount>t){n[r].amount-=t}else{n.splice(r,1);t--}}}};MapManager.prototype.createInstances=function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];var i=parseInt(r[0]);var s=parseInt(r[1]);var o=parseInt(r[2]);var u=parseInt(r[3]);var a=vec3(s+.5,o+.5,u);if(i==0){this.instances.push(new Billboard(a,r[4],r.splice(5),this))}else if(i==1){this.doors.push(new Door(a,r[5],r[4],r.splice(6),this))}else if(i==2){this.instances.push(new Enemy(a,parseInt(r[4]),r[5],this))}else if(i==3){this.traps.push({position:vec2(s,o)})}else if(i==4){this.instances.push(new Item(a,r[4],r.splice(5),this))}else if(i==5){this.doors.push(new Door(a,r[5],r[4],r.splice(6),this))}else if(i==6){var f=this.game.getTextureIdByCode(r[4]+"_0");this.waterTiles.push(f);this.animatedTiles.push(f)}}};MapManager.prototype.loop=function(){this.player.loop();this.sectorInstances=[];this.sectorDoors=[];for(var e=0,t=this.instances.length;e<t;e++){var n=this.instances[e];if(n.loop)n.loop();if(!n.inMap){this.instances.splice(e,1);t--;e--}else{var r=Math.abs(n.position.a-this.player.position.a);var i=Math.abs(n.position.b-this.player.position.b);if(r<10&&i<10)this.sectorInstances.push(n)}}for(var e=0,t=this.doors.length;e<t;e++){var n=this.doors[e];if(n.loop)n.loop();var r=Math.abs(n.position.a-this.player.position.a);var i=Math.abs(n.position.b-this.player.position.b);if(r<10&&i<10)this.sectorDoors.push(n)}this.worldFrame+=this.worldFrameSpeed;if(this.worldFrame>=2)this.worldFrame=0}
function Player(e,t,n){this.position=e;this.direction=Math.degToRad(t);this.mapManager=n;this.rotationSpd=Math.degToRad(5);this.movementSpd=.1;this.canMove=true;this.z=32;this.targetZ=32;this.jogZ=vec2(0,0)}Player.prototype.jog=function(){var e=this.jogZ.b==0?1:-1;var t=this.z==10?2:1.5;var n=this.z==10?.4:.25;this.jogZ.a+=n*e;if(this.jogZ.a>=t)this.jogZ.set(t,1);else if(this.jogZ.a<=-t)this.jogZ.set(-t,0)};Player.prototype.moveTo=function(e,t,n){var r=this.movementSpd*2;var i=this.position.a+e*r;var s=this.position.b;var o=i<<0;var u=s<<0;var a=this.z==10?3:1;if(n)a*=2;if(!this.mapManager.isSolid(o,u)){var f=this.mapManager.getInstanceAt(o,u);if(!f||!f.isSolid(i,s))this.position.a+=e*(this.movementSpd/a)}i=this.position.a;s=this.position.b+t*r;o=i<<0;u=s<<0;if(!this.mapManager.isSolid(o,u)){var f=this.mapManager.getInstanceAt(o,u);if(!f||!f.isSolid(i,s))this.position.b+=t*(this.movementSpd/a)}this.jog();if(this.mapManager.checkIfWater(this.position.a<<0,this.position.b<<0)){this.targetZ=10}else{this.targetZ=32}};Player.prototype.movement=function(){var e=this.mapManager.game;var t=0,n=0,r=false;if(e.keys[87]==1){t=Math.cos(this.direction);n=-Math.sin(this.direction)}else if(e.keys[83]==1){t=-Math.cos(this.direction);n=Math.sin(this.direction)}if(e.keys[65]==1){r=true;t=Math.cos(this.direction+Math.PI_2);n=-Math.sin(this.direction+Math.PI_2)}else if(e.keys[68]==1){r=true;t=-Math.cos(this.direction+Math.PI_2);n=Math.sin(this.direction+Math.PI_2)}if(t!=0||n!=0){this.moveTo(t,n,r)}else{this.jogZ.set(0,0)}};Player.prototype.rotation=function(){var e=this.mapManager.game;if(e.keys[81]==1){this.direction+=this.rotationSpd;this.direction=(this.direction+Math.PI2)%Math.PI2}else if(e.keys[69]==1){this.direction-=this.rotationSpd;this.direction=(this.direction+Math.PI2)%Math.PI2}};Player.prototype.checkInstance=function(){var e=this.mapManager.game;if(e.getKeyPressed(13)){var t=this.position.a+Math.cos(this.direction)*.9<<0;var n=this.position.b-Math.sin(this.direction)*.9<<0;var r=this.mapManager.getInstanceAt(t,n);if(r!=null&&r.active){r.active()}}else if(e.getKeyPressed(0)){var t=this.position.a+Math.cos(this.direction)*.9<<0;var n=this.position.b-Math.sin(this.direction)*.9<<0;var r=this.mapManager.getInstanceAt(t,n);if(r!=null&&r.active&&!r.visible){r.active()}}};Player.prototype.step=function(){if(!this.canMove)return;this.rotation();this.movement();this.checkInstance()};Player.prototype.changeZValue=function(){if(this.targetZ<this.z){this.z-=5;if(this.z<=this.targetZ)this.z=this.targetZ}else if(this.targetZ>this.z){this.z+=3;if(this.z>=this.targetZ)this.z=this.targetZ}};Player.prototype.loop=function(){this.step();this.changeZValue();if(this.mapManager.isOnTrap(this.position)){this.canMove=false}}
function RaycastRender(e,t,n,r){this.game=r;this.canvas=e;var i=new ArrayBuffer(e.data.length);this.buf8=new Uint8ClampedArray(i);this.buf32=new Uint32Array(i);this.buf32[1]=168496141;this.isLittleEndian=true;if(i[4]==10&&i[5]==11&&i[6]==12&&i[7]==13)this.isLittleEndian=false;this.size=vec2(e.width,e.height);this.fov=Math.degToRad(t/2);this.angVar=Math.degToRad(t/this.size.a);this.fullFov=Math.degToRad(t);this.lineJ=this.size.a*4;this.heightR=n;this.fog=null;this.baseHeight=32;this.rBase=this.heightR/this.baseHeight;this.floorR=90/this.baseHeight;this.z=this.baseHeight;this.zAngle=0;this.vspeed=0;this.activeInstance=null;this.sinList=[];this.cosList=[];this.lastDir=-1;this.matDist=new Array(this.size.a)}RaycastRender.prototype.getAlphaByDistance=function(e){var t=255;if(this.fog!=null){if(e>this.fog.b){t=0}else if(e>this.fog.a){var n=(e-this.fog.a)/(this.fog.b-this.fog.a)*255;t=255-n}}return t<<0};RaycastRender.prototype.setFog=function(e,t){this.fog=vec2(e,t)};RaycastRender.prototype.plot=function(e,t,n,r){if(r===null)r=255;if(this.isLittleEndian){this.buf32[t*this.size.a+e]=r<<24|n[2]<<16|n[1]<<8|n[0]}else{this.buf32[t*this.size.a+e]=n[0]<<24|n[1]<<16|n[2]<<8|r}};RaycastRender.prototype.fillLine=function(e,t,n,r,i,s,o,u){var a=n-t;var f=Colors.alphaC;r=r<<0;var l=0;var c=this.size.b;if(n>c)n=c;if(t>0)l=t;if(n<c)c=n;var h=this.size.b/2;var p,d,v;for(var m=l;m<c;m++){if(u>1)p=(m-t)/a*i.height*u%(i.height-1)<<0;else p=(m-t)/a*(i.height-1)<<0;if(p<i.offsetT||p>=i.offsetB){continue}p-=i.offsetT;d=r+p*i.innerW;v=s[i.texData[d]];if(!v)throw r+" _ "+p+" _ "+d+" _ "+i.name;if(f[0]==v[0]&&f[1]==v[1]&&f[2]==v[2]){continue}this.plot(e,m,v,o)}};RaycastRender.prototype.raycast=function(e){var t=e.map;var n=e.floor;var r=e.ceil;var i=e.player.position;var s=e.player.direction;var o=s+this.fov;var u=0;var a=null;this.activeInstance=null;this.z=e.player.z+e.player.jogZ.a<<0;var f=this.size.b/2<<0;var l=null;var c=null;var h=Math;this.lookUpDown(e.game);for(var p=0;p<this.size.a;p++){if(s!=this.lastDir){this.cosList[p]=h.cos(o);this.sinList[p]=h.sin(o)}var d=vec2(this.cosList[p],-this.sinList[p]);var v=i.clone();var m=i.clone();var g=vec2(1,1);var y=vec2(1,1);var b=vec2(-1,-1);var w=null;var E=-1;var S=h.tan(o);var x=false;var T=false,N=false;var C,k;var L=0;var A=h.abs(s-o);var O=h.cos(A);var M,_,D;var P;var H=null;if(d.a>0){v.a=1+v.a<<0}else if(d.a<0){v.a=(v.a<<0)-.001;g.a=-1}if(d.b>0){m.b=1+m.b<<0}else if(d.b<0){m.b=(m.b<<0)-.001;y.b=-1}g.b=-g.a*S;y.a=-y.b/S;v.b=i.b-(v.a-i.a)*S;m.a=i.a-(m.b-i.b)/S;while(!x){if(!T){C=v.a<<0;k=v.b<<0;if(t[k]==undefined||t[k][C]!=0){v.a=h.round(v.a);var B=v.a-i.a;b.a=h.abs(B/d.a);if(t[k])_=t[k][C];T=true}else{v.sum(g)}}if(!N){C=m.a<<0;k=m.b<<0;if(t[k]==undefined||t[k][C]!=0){m.b=h.round(m.b);var B=m.b-i.b;b.b=h.abs(B/d.b);if(t[k])D=t[k][C];N=true}else{m.sum(y)}}x=T&&N}if(h.abs(b.a-b.b)<=.01){if(u==2&&D==a)b.a=b.b+3;else if(u==1&&_==a)b.b=b.a+3}u=b.a<b.b?1:2;E=b.a<b.b?b.a:b.b;w=b.a<b.b?v:m;_=b.a<b.b?_:D;M=this.game.getTexture(_);if(!M)continue;P=b.a<b.b?w.b*M.width%M.width:w.a*M.width%M.width;H=b.a<b.b?Colors.textures:Colors.texturesShadow;a=_;E*=O;var j=this.rBase*this.z;var F=j/E;L=this.heightR/E;var I=this.z-32;var q=h.round(this.size.b/2+F/2)+this.zAngle+I;var R=h.round(q-L*e.height);this.matDist[p]=E;var U=this.getAlphaByDistance(E);this.fillLine(p,R,q,P,M,H,U,e.height);var z=Colors.blackC;this.plot(p,0,z,255);var W=q;var X=f+this.zAngle+I;var V=this.floorR*this.z/O;for(var $=W;$<this.size.b;$++){var J=$;var K=h.abs(f-$+this.zAngle+I);var Q=V/K;var G=i.a+d.a*Q;var Y=i.b+d.b*Q;var Z=G<<0;var et=Y<<0;if(!n[et])continue;var tt=n[et][Z];if(e.isAnimated(tt))tt+=e.worldFrame<<0;l=this.game.getTexture(tt);if(!l){continue}var nt=G*l.width%l.width<<0;var rt=Y*l.height%l.height<<0;var it=nt+rt*l.innerW;var st=Colors.textures[l.texData[it]];if(st){var ot=255;if(this.fog!=null){if($<X){ot=(X-$)/f*255}else if($>=X){ot=($-X)/f*255}}if(ot>255)ot=255;this.plot(p,J,st,ot)}}var W=R-1;var ut=64*e.height-this.z;V=this.floorR*ut/O;for(var $=W;$>=0;$--){var K=h.abs(f-$+this.zAngle+I);var Q=V/K;var G=i.a+d.a*Q;var Y=i.b+d.b*Q;var Z=G<<0;var et=Y<<0;if(!r[et])continue;var tt=r[et][Z];if(e.isAnimated(tt))tt+=e.worldFrame<<0;c=this.game.getTexture(tt);if(!c){continue}var nt=G*c.width%c.width<<0;var rt=Y*c.height%c.height<<0;var it=nt+rt*c.innerW;var at=Colors.textures[c.texData[it]];if(at){var ot=255;if(this.fog!=null){if($<X){ot=(X-$)/f*255}else if($>=X){ot=($-X)/f*255}}if(ot>255)ot=255;this.plot(p,$,at,ot)}}o-=this.angVar}var ft=this.doorCasting(i,s,e.sectorDoors,e.height);var lt=this.objectCasting(i,s,e.sectorInstances);this.renderInstances(lt,ft);this.canvas.data.set(this.buf8);this.lastDir=s};RaycastRender.prototype.castTo=function(e,t,n,r,i,s){var o=Math;var u=o.getAngle(e,t);var a=o.abs(o.getShortAngle(u,i));var f=o.abs(o.getShortAngle(u,n));var l=o.abs(o.getShortAngle(u,r));u+=o.PI2;n+=o.PI2;r+=o.PI2;if(f<l){if(u>n&&u<r)f*=-1;else if(u<n&&u<r&&n>r)f*=-1;else if(u>n&&u>r&&n>r)f*=-1}var c=f/this.fullFov*this.size.a;if(c>1e3)return null;var h=o.getDistance(e,t);var p=o.cos(a);var d=h*p;var v=false;if(d<=0&&!s)return;if(a>=1.03&&s){d=h*(2/(a+3));var v=true}var m=this.heightR/d;var g=this.rBase*this.z;var y=g/d;c=o.round(c);return{x:c,dist:d,scale:m,angle:u,zScale:y,onBack:v}};RaycastRender.prototype.objectCasting=function(e,t,n){var r=Math;var i=(t+this.fov+r.PI2)%r.PI2;var s=(t-this.fov+r.PI2)%r.PI2;var o=[];for(var u=0,a=n.length;u<a;u++){var f=n[u];if(!f.visible)continue;var l=r.abs(f.position.a-e.a);var c=r.abs(f.position.b-e.b);if(l>10||c>10)continue;var h=this.castTo(e,f.position,i,s,t,false);if(!h)continue;h.x=r.round(h.x-h.scale/2);var p={ins:f,scale:h.scale,dist:h.dist,x:h.x,angle:h.angle,type:0,zScale:h.zScale};var d=false;for(var v=0,m=o.length;v<m;v++){if(h.dist>o[v].dist){o.splice(v,0,p);v=m;d=true}}if(!d){o.push(p)}}return o};RaycastRender.prototype.doorCasting=function(e,t,n,r){var i=Math;var s=(t+this.fov+i.PI2)%i.PI2;var o=(t-this.fov+i.PI2)%i.PI2;var u=[];for(var a=0,f=n.length;a<f;a++){var l=n[a];var c=i.abs(l.position.a-e.a);var h=i.abs(l.position.b-e.b);if(c>10||h>10)continue;var p=!(l.direction=="H"||l.direction=="V");pos=l.leftPos;var d=this.castTo(e,pos,s,o,t,p);if(!d)continue;if(p&&d.angle<o&&d.angle>o-Math.PI_2)continue;pos=l.rightPos;var v=this.castTo(e,pos,s,o,t,p);if(!v)continue;if(p&&v.angle>s&&v.angle<s+Math.PI_2)continue;if(d.onBack&&v.onBack)continue;var m=p?r:1;var g={ins:l,scale1:d.scale,dist:d.dist,x1:d.x,scale2:v.scale,dist2:v.dist,x2:v.x,type:1,zScale1:d.zScale,zScale2:v.zScale,height:m};var y=false;for(var b=0,w=u.length;b<w;b++){if(d.dist>u[b].dist){u.splice(b,0,g);b=w;y=true}}if(!y){u.push(g)}}return u};RaycastRender.prototype.drawDoor=function(e){if(e.dist>15)return;var t=this.size.b/2;var n=Math;var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,e,y,b,w,E;m=Colors.textures;d=this.game.textures[e.ins.getTexture()];if(e.x1<e.x2){i=e.x1;s=e.x2;a=e.scale1<e.scale2?1:-1;f=e.scale1;sZ=e.zScale1;E=1}else{i=e.x2;s=e.x1;a=e.scale1<e.scale2?-1:1;f=e.scale2;sZ=e.zScale2;E=-1}if(i<0&&s<0||i>this.size.a&&s>this.size.a)return;c=e.dist<e.dist2?e.dist:e.dist2;l=n.abs(e.scale2-e.scale1)/(s-i);zs=n.abs(e.zScale2-e.zScale1)/(s-i);var S=this.getAlphaByDistance(c);r=0;h=s-i;if(i<0){r=-i;i=0}if(s>this.size.a)s=this.size.a;var x=this.z-32;var T=this.size.b/2<<0;for(g=i;g<s;g++){r++;if(c<=this.matDist[g]){zSc=sZ+zs*r*a;p=f+l*r*a;u=n.round(t+zSc/2)+this.zAngle+x-p*e.ins.position.c;o=n.round(u-p*e.height);if(e.ins.openable&&this.game.mouseB==1&&e.dist<=1){var N=this.game.cursorPos;if(N.a>i&&N.a<s&&N.b>o&&N.b<u){this.activeInstance=e.ins}}v=r/h*d.width<<0;if(E==-1)v=d.width-v-1;if(v<0)v=0;this.fillLine(g,o,u,v,d,m,S,e.height)}}};RaycastRender.prototype.drawInstance=function(e){if(e.dist>15||e.dist<.01)return;var t=Math;var n,r,i,s,o,u,a,f,l,c,h;var p=this.z-32;var d=this.size.b/2<<0;r=t.round(d+e.zScale/2)+this.zAngle+p-e.scale*e.ins.position.c;n=t.round(r-e.scale);i=e.ins.getTexture(e.angle);if(i.texCode=="none")return;s=this.game.getBillboard(i.texCode);o=Colors.billboards;u=e.scale/s.h;var v=this.getAlphaByDistance(e.dist);if(t.abs(e.scale)>=1e3)return;if(e.x+e.scale<0)return;else if(e.x>this.size.a)return;if(e.ins.active&&this.game.mouseB==1&&e.dist<=1){var m=this.game.cursorPos;if(m.a>e.x&&m.a<e.x+e.scale&&m.b>n&&m.b<r){this.activeInstance=e.ins}}for(l=0;l<e.scale;l++){c=e.x+l;if(c>0&&c<this.size.a){if(e.dist<this.matDist[c]){h=l/e.scale*s.width<<0;if(h<s.offsetL||h>=s.offsetR)continue;if(i.xScale==-1)h=s.width-h-s.invOffR;else h-=s.offsetL;this.fillLine(c,n,r,h,s,o,v,1)}}}};RaycastRender.prototype.renderInstances=function(e,t){for(var n=0,r=t.length;n<r;n++){var i=false;for(var s=0,o=e.length;s<o;s++){if(t[n].dist>e[s].dist){e.splice(s,0,t[n]);i=true;s=o}}if(!i){e.push(t[n])}}for(var n=0,r=e.length;n<r;n++){var u=e[n];if(u.type==0){this.drawInstance(u)}else if(u.type==1){this.drawDoor(u)}}this.game.keys[0]=0;if(this.activeInstance!=null){this.game.getMouseButtonPressed();this.activeInstance.active()}else if(this.game.getMouseButtonPressed()){this.game.keys[0]=1}};RaycastRender.prototype.draw=function(e,t){e.putImageData(this.canvas,t.a,t.b)};RaycastRender.prototype.lookUpDown=function(e){if(e.keys[49])this.zAngle+=3;else if(e.keys[50])this.zAngle=0;else if(e.keys[51])this.zAngle-=3;if(this.zAngle>75)this.zAngle=75;else if(this.zAngle<-75)this.zAngle=-75}
function Texture(e,t,n,r,i,s,o,u,a){this.texData=e;this.name=t;this.width=n;this.height=r;this.offsetL=i;this.offsetR=s;this.offsetT=o;this.offsetB=u;this.solid=a;this.bytesOff=o*n+i;this.innerW=s-i;this.invOffR=n-s}
function TitleScreen(e){this.game=e;this.blink=30}TitleScreen.prototype.step=function(){if(this.game.getKeyPressed(13)||this.game.getMouseButtonPressed()){this.game.loadMap("kramBuild.ktd");this.game.scene=null;this.game.playMusic("descent")}};TitleScreen.prototype.loop=function(){this.step();var e=this.game.getCtx();e.drawImage(this.game.images.titleS,0,0);if(this.blink-->15){e.font=this.game.font;e.fillStyle="white";e.textAlign="center";e.fillText("Click To Continue",e.width/2,88);e.textAlign="left"}else if(this.blink==0){this.blink=30}}
function Vec2(e,t,n){this.a=e;this.b=t;this.c=n}function vec2(e,t){return new Vec2(e,t,0)}function vec3(e,t,n){return new Vec2(e,t,n)}Vec2.prototype.equals=function(e,t){if(e.a!==undefined){return this.a==e.a&&this.b==e.b}else{return this.a==e&&this.b==t}};Vec2.prototype.set=function(e,t){if(e.a!=undefined){this.a=e.a;this.b=e.b}else{this.a=e;this.b=t}};Vec2.prototype.sum=function(e,t){if(e.a!==undefined){this.a+=e.a;this.b+=e.b}else{this.a+=e;this.b+=t}};Vec2.prototype.mult=function(e){this.a*=e;this.b*=e};Vec2.prototype.clone=function(){return vec2(this.a,this.b)}